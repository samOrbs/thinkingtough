{
	"nodes":[
		{"id":"g_phase2","type":"group","x":-100,"y":420,"width":2200,"height":530,"color":"6","label":"BUILD STEP 2: Indexing Pipeline — COMPLETED | Commit 2f34509"},
		{"id":"g_phase3","type":"group","x":-100,"y":1070,"width":2200,"height":530,"color":"4","label":"BUILD STEP 3: Retrieval Pipeline — COMPLETED | Commit d841bae"},
		{"id":"g_phase4","type":"group","x":-100,"y":1720,"width":2200,"height":530,"color":"5","label":"BUILD STEP 4: Generation + Chat UI — COMPLETED | Commit 0548847"},
		{"id":"g_phase1","type":"group","x":-100,"y":-200,"width":2200,"height":500,"color":"1","label":"BUILD STEP 1: OCR Pipeline — COMPLETED | Commit 2babf15"},
		{"id":"g_summary","type":"group","x":-100,"y":2380,"width":2200,"height":400,"color":"2","label":"BUILD SUMMARY — Total Cost & Git History"},
		{"id":"g_phase5","type":"group","x":-100,"y":2900,"width":2200,"height":630,"color":"2","label":"BUILD STEP 5: Multi-Book System — COMPLETED"},
		{"id":"g_future","type":"group","x":-100,"y":3650,"width":2200,"height":350,"color":"3","label":"FUTURE ENHANCEMENTS"},
		{"id":"title","type":"text","text":"# Work Log\n## Build Record — What Was Actually Done in Each Phase","x":200,"y":-400,"width":800,"height":100},
		{"id":"s1_clean","type":"text","text":"**Text Cleaning — Done**\nHyphen rejoin: `re` regex\nUnicode: `unicodedata.normalize`\nWhitespace cleanup\nNo headers/footers needed","x":730,"y":-100,"width":280,"height":160,"color":"1"},
		{"id":"s1_structure","type":"text","text":"**Structure Detection — Done**\nChapter headings via regex\n`ALL CAPS` line detection\nJSON output with page ranges\nMarkdown heading tagging","x":1100,"y":-100,"width":280,"height":150,"color":"1"},
		{"id":"s2_fulltext","type":"text","text":"**INPUT (v2)**\n202 content pages loaded\nSkipped pp 1-15 (front matter)\nSkipped pp 218-232 (index)\nFiltered noise & duplicates","x":0,"y":520,"width":250,"height":165,"color":"6"},
		{"id":"s2_verify","type":"text","text":"**Verified & Committed**\nIndex built successfully\nCommit: `2f34509`\n\"Phase 2: Indexing pipeline —\nchunk, embed, store\"","x":1440,"y":520,"width":250,"height":185,"color":"6"},
		{"id":"s2_cost","type":"text","text":"**Actual Cost: ~$0.001**\n~150K tokens for embedding\nChromaDB & BM25: Free (local)","x":0,"y":700,"width":400,"height":110},
		{"id":"s2_files","type":"text","text":"**Files created:**\n`src/indexing.py` — chunking, embedding, ChromaDB + BM25 storage","x":0,"y":810,"width":400,"height":105},
		{"id":"s3_expand","type":"text","text":"**Query Pipeline — Done**\nClassify → 6 types\nExpand → 2 variants\nHyDE for conceptual queries\nLLM rerank top-15 → top-5","x":310,"y":1170,"width":280,"height":160,"color":"4"},
		{"id":"s1_script","type":"text","text":"**`src/ocr.py` written**\n`google.genai` Client SDK\nGemini 2.0 Flash vision API\nResume support (skips done)\nDetailed OCR prompt","x":340,"y":-100,"width":300,"height":150,"color":"1"},
		{"id":"s1_output","type":"text","text":"**OUTPUT — 232/232 pages**\n`data/pages_markdown/`\n`page_0001.md` → `page_0232.md`\n+ `data/book_structure.json`\n**0 failures**","x":1470,"y":-100,"width":280,"height":200,"color":"1"},
		{"id":"s1_verify","type":"text","text":"**Verified & Committed**\nAll 232 pages confirmed\nCommit: `2babf15`\n\"Phase 1: OCR pipeline —\n232 pages transcribed\"","x":1840,"y":-100,"width":250,"height":160,"color":"1"},
		{"id":"s1_cost","type":"text","text":"**Actual Cost: ~$0.06**\n~140K input tokens + ~116K output tokens\nGemini 2.0 Flash: $0.10/1M in, $0.40/1M out","x":600,"y":60,"width":400,"height":120},
		{"id":"s2_chunk","type":"text","text":"**Semantic Chunking (v2)**\nCross-page chunking\n~400 tokens, 80 overlap\nParagraph deduplication\n146 chunks from 1036 paras","x":340,"y":520,"width":280,"height":160,"color":"6"},
		{"id":"s2_embed","type":"text","text":"**Gemini Embeddings — Done**\n`gemini-embedding-001`\n**3072 dimensions** (not 768)\nBatch size 100\nAll chunks embedded","x":710,"y":520,"width":280,"height":160,"color":"6"},
		{"id":"s2_chroma","type":"text","text":"**ChromaDB — Done**\nPersistent: `data/chroma_db/`\nCosine similarity\nCollection: `toughness_training`\nWith metadata per chunk","x":1080,"y":520,"width":260,"height":165,"color":"6"},
		{"id":"s1_input","type":"text","text":"**INPUT**\n232 JPG pages from\nInternet Archive scraper\n`pages/page_0001.jpg` →\n`pages/page_0232.jpg`","x":0,"y":-100,"width":250,"height":150,"color":"1"},
		{"id":"s1_files","type":"text","text":"**Files created:**\n`src/ocr.py` — OCR + cleaning + structure detection (162 lines)","x":0,"y":60,"width":400,"height":120},
		{"id":"ss_commits","type":"text","text":"**Git Commits (6 total)**\n`e9bd0cf` Initial commit\n`d19ecbc` Implementation plan canvas\n`2babf15` Phase 1: OCR pipeline\n`2f34509` Phase 2: Indexing pipeline\n`d841bae` Phase 3: Retrieval pipeline\n`0548847` Phase 4: Generation + UI","x":0,"y":2470,"width":400,"height":200,"color":"2"},
		{"id":"ss_stack","type":"text","text":"**Tech Stack**\nLLM: Gemini 2.5 Flash (migrated)\nEmbeddings: gemini-embedding-001\nVector DB: ChromaDB (local)\nKeyword: BM25 (rank_bm25)\nFusion: RRF + LLM Reranker\nUI: Chainlit (streaming)\nMemory: SQLite\nSDK: google-genai","x":950,"y":2470,"width":350,"height":250,"color":"2"},
		{"id":"ss_known","type":"text","text":"**Known Issues / Future Work**\n1. ~~Front matter pages pollute retrieval~~ FIXED\n2. ~~No reranking~~ DONE (LLM reranker)\n3. ~~No contextual enrichment~~ DONE\n4. ~~No query classification~~ DONE (6 types)\n5. ~~No HyDE~~ DONE (conceptual queries)\n6. ~~No response validation~~ DONE\n7. ~~gemini-2.0-flash deprecated~~ Migrated to 2.5\n8. ~~Single book only~~ DONE (multi-book)\n9. No evaluation suite yet\n10. No agentic tools yet\n11. No model routing yet\n12. 3 new books need OCR + indexing (~$1.17)","x":1400,"y":2470,"width":350,"height":310,"color":"2"},
		{"id":"s5_registry","type":"text","text":"**Book Registry — Done**\n`src/books.py` — BookConfig\ndataclass with derived paths\n`discover_books()`, `get_indexed_books()`\n4 books configured with config.json","x":0,"y":3000,"width":280,"height":170,"color":"2"},
		{"id":"s5_migrate","type":"text","text":"**Data Migration — Done**\nMoved toughness-training data\nto `books/toughness-training/`\nCopied Inner Game PDF\nExisting ChromaDB compatible","x":370,"y":3000,"width":280,"height":170,"color":"2"},
		{"id":"s5_pipeline","type":"text","text":"**Pipeline Updates — Done**\n• ocr.py: PDF auto-detect, PyMuPDF\n• indexing.py: per-book, book metadata\n• retrieval.py: multi-book, namespaced IDs\n• generation.py: dynamic system prompt\n• memory.py: book selection persistence","x":740,"y":3000,"width":300,"height":170,"color":"2"},
		{"id":"s5_ui","type":"text","text":"**Chainlit UI — Done**\nSwitch toggles per book\non_settings_update handler\n[Book, Page X] multi-book\nDynamic welcome message","x":1130,"y":3000,"width":280,"height":170,"color":"2"},
		{"id":"s5_status","type":"text","text":"**Status**\nCode: ✅ all modules updated\nData: toughness-training indexed\n3 new books: awaiting OCR + index\n(~$1.17, user approval needed)","x":1500,"y":3000,"width":280,"height":170,"color":"2"},
		{"id":"s5_files","type":"text","text":"**Files changed:**\n`src/books.py` NEW | `src/ocr.py` `src/indexing.py` `src/retrieval.py`\n`src/generation.py` `src/memory.py` `app.py` UPDATED\n`books/*/config.json` (4 books) | `requirements.txt` (+pymupdf)","x":0,"y":3200,"width":700,"height":110},
		{"id":"s5_issues","type":"text","text":"**Design decisions:**\n1. Per-book ChromaDB dirs (not shared collection) — cleaner isolation\n2. Namespaced IDs ({slug}:{chunk_id}) prevent cross-book collisions\n3. Book metadata in chunks for backward-compat with existing index\n4. PDF auto-detect: sample 5 mid-book pages for text density","x":800,"y":3200,"width":500,"height":160},

		{"id":"sf_enrich","type":"text","text":"**Contextual Enrichment** ✅\nAnthropic method\n67% better retrieval\nCost: ~$0.35 one-time","x":0,"y":3740,"width":280,"height":130,"color":"3"},
		{"id":"sf_raptor","type":"text","text":"**RAPTOR Summaries**\nMulti-level abstractions\nBetter chapter questions\nStatus: NOT STARTED","x":720,"y":3740,"width":260,"height":130,"color":"3"},
		{"id":"sf_agents","type":"text","text":"**Agentic Tools**\nNotes, flashcards, plans\nChapter summaries\nStatus: NOT STARTED","x":1070,"y":3740,"width":260,"height":130,"color":"3"},
		{"id":"s4_prompt","type":"text","text":"**System Prompt — Done**\nBook expert persona\n7 rules incl. citations\n[Page X] format enforced\nDistinguish book vs analysis","x":0,"y":1820,"width":280,"height":165,"color":"5"},
		{"id":"s4_verify","type":"text","text":"**Verified & Committed**\nServer starts on :8000\nHTTP 200 confirmed\nCommit: `0548847`\n\"Phase 4: Generation +\nChainlit chat UI\"","x":1480,"y":1820,"width":280,"height":170,"color":"5"},
		{"id":"s4_done","type":"text","text":"**CHATBOT LIVE**\n`chainlit run app.py`\nhttp://localhost:8000\nStreaming responses\nPage citations in sidebar","x":1850,"y":1820,"width":240,"height":165,"color":"5"},
		{"id":"s4_cost","type":"text","text":"**Actual Cost per query: ~$0.001** | Gemini Flash generation\n**Estimated monthly (50 q/day): ~$1.50**","x":0,"y":1990,"width":500,"height":90},
		{"id":"s4_files","type":"text","text":"**Files created:**\n`src/generation.py` | `src/memory.py` | `app.py` | `requirements.txt`","x":0,"y":2100,"width":500,"height":100},
		{"id":"ss_cost","type":"text","text":"**Total Build Cost**\nOCR (232 pages): ~$0.06\nEmbeddings: ~$0.001\nContextual Enrichment: ~$0.35\nQuery expansion: ~$0.0003/query\nClassify + HyDE: ~$0.0005/query\nReranker: ~$0.0002/query\nGeneration: ~$0.001/query\n\n**One-time build: ~$0.41**\n**Per query: ~$0.002**\n**Monthly (50q/day): ~$3**","x":500,"y":2470,"width":350,"height":250,"color":"2"},
		{"id":"sf_rerank","type":"text","text":"**LLM Reranker** ✅\nGemini 2.5 Flash cross-encoder\nScores top-15 → top-5\nCost: ~$0.0002/query","x":370,"y":3740,"width":260,"height":130,"color":"3"},
		{"id":"sf_routing","type":"text","text":"**Model Routing**\nSimple → Gemini Flash\nComplex → Claude Sonnet\nStatus: NOT STARTED","x":1420,"y":3740,"width":260,"height":130,"color":"3"},
		{"id":"sf_eval","type":"text","text":"**Evaluation Suite**\nRAGAS + DeepEval\n50+ test Q&A pairs\nStatus: NOT STARTED","x":1770,"y":3740,"width":260,"height":130,"color":"3"},
		{"id":"s3_input","type":"text","text":"**INPUT**\nUser query string\n(history used in\ngeneration, not retrieval)","x":0,"y":1170,"width":220,"height":160,"color":"4"},
		{"id":"s3_search","type":"text","text":"**Hybrid Search — Done**\nVector: top-20 per query\nfrom ChromaDB\nBM25: top-20 per query\nfrom pickled index","x":680,"y":1170,"width":280,"height":160,"color":"4"},
		{"id":"s3_fuse","type":"text","text":"**Rank Fusion — Done**\nReciprocal Rank Fusion\nk=60 constant\nDeduplication by chunk text\nMerged ranked list","x":1050,"y":1170,"width":260,"height":160,"color":"4"},
		{"id":"s3_assemble","type":"text","text":"**Context Assembly — Done**\nTop-5 chunks selected\nFormatted with [Page X]\ncitations for each chunk\nReturns context + sources","x":1400,"y":1170,"width":260,"height":160,"color":"4"},
		{"id":"s3_verify","type":"text","text":"**Verified & Committed**\nCommit: `d841bae`\n\"Phase 3: Retrieval —\nhybrid search with\nrank fusion\"","x":1750,"y":1170,"width":250,"height":160,"color":"4"},
		{"id":"s4_generate","type":"text","text":"**LLM Generation — Done**\nGemini 2.5 Flash (migrated)\n`build_prompt()` assembles:\nsystem + history + context\n+ current question\n+ citation validation","x":370,"y":1820,"width":280,"height":165,"color":"5"},
		{"id":"s4_chainlit","type":"text","text":"**Chainlit Chat UI — Done**\n`app.py` entry point\n`stream_token()` streaming\nSource panel with page text\nWelcome message on start","x":740,"y":1820,"width":280,"height":170,"color":"5"},
		{"id":"s4_memory","type":"text","text":"**SQLite Memory — Done**\n`data/memory.db`\n`conversations` table\n`sessions` table\nLast 20 turns in context","x":1110,"y":1820,"width":280,"height":165,"color":"5"},
		{"id":"s3_cost","type":"text","text":"**Actual Cost per query: ~$0.0003**\nQuery expansion only (Gemini Flash)\nVector search + BM25 + fusion: Free (local compute)","x":0,"y":1330,"width":500,"height":110},
		{"id":"s3_files","type":"text","text":"**Files created:**\n`src/retrieval.py` — expand, search, fuse, assemble","x":0,"y":1440,"width":400,"height":100},
		{"id":"s1_issues","type":"text","text":"**Issues encountered:**\n1. `google.generativeai` deprecated → switched to `google.genai`\n2. Front matter pages (cover, book lists) OCR'd fine but pollute retrieval later","x":1065,"y":100,"width":500,"height":160},
		{"id":"s2_bm25","type":"text","text":"**BM25 Index (v2)**\n`rank_bm25` library\n`data/bm25_index.pkl`\nStored as plain dicts\n(fixes pickle module issue)","x":1080,"y":695,"width":260,"height":130,"color":"6"},
		{"id":"s2_issues","type":"text","text":"**Issues encountered & fixed:**\n1. `text-embedding-004` 404 → `gemini-embedding-001` (3072 dims)\n2. v1: 232 chunks (1 per page) — too coarse, front matter dominated\n3. v2: cross-page chunking, dedup, skip pp 1-15 & 218-232\n4. BM25 pickle `__main__.Chunk` error → store as plain dicts\n5. ChromaDB rejects list metadata → stringify page lists","x":510,"y":705,"width":500,"height":210},
		{"id":"s3_issues","type":"text","text":"**Issues encountered & fixed:**\n1. BM25 unpickling `__main__.Chunk` → fixed by storing dicts\n2. Front matter pages ranked too high → FIXED in indexing v2\n3. Foreword pages still appear occasionally (broad content)","x":600,"y":1330,"width":500,"height":180}
	],
	"edges":[
		{"id":"e_s1_1","fromNode":"s1_input","fromSide":"right","toNode":"s1_script","toSide":"left","color":"#e94560"},
		{"id":"e_s1_2","fromNode":"s1_script","fromSide":"right","toNode":"s1_clean","toSide":"left","color":"#e94560"},
		{"id":"e_s1_3","fromNode":"s1_clean","fromSide":"right","toNode":"s1_structure","toSide":"left","color":"#e94560"},
		{"id":"e_s1_4","fromNode":"s1_structure","fromSide":"right","toNode":"s1_output","toSide":"left","color":"#e94560"},
		{"id":"e_s1_5","fromNode":"s1_output","fromSide":"right","toNode":"s1_verify","toSide":"left","color":"#e94560"},
		{"id":"e_p1_to_p2","fromNode":"s1_output","fromSide":"bottom","toNode":"s2_fulltext","toSide":"top","color":"#f59e0b","label":"232 markdown files"},
		{"id":"e_s2_1","fromNode":"s2_fulltext","fromSide":"right","toNode":"s2_chunk","toSide":"left","color":"#f59e0b"},
		{"id":"e_s2_2","fromNode":"s2_chunk","fromSide":"right","toNode":"s2_embed","toSide":"left","color":"#f59e0b"},
		{"id":"e_s2_3","fromNode":"s2_embed","fromSide":"right","toNode":"s2_chroma","toSide":"left","color":"#f59e0b"},
		{"id":"e_s2_4","fromNode":"s2_chunk","fromSide":"bottom","toNode":"s2_bm25","toSide":"left","color":"#f59e0b"},
		{"id":"e_s2_5","fromNode":"s2_chroma","fromSide":"right","toNode":"s2_verify","toSide":"left","color":"#f59e0b"},
		{"id":"e_p2_to_p3","fromNode":"s2_chroma","fromSide":"bottom","toNode":"s3_search","toSide":"top","color":"#3b82f6","label":"Vector + BM25 stores"},
		{"id":"e_s3_1","fromNode":"s3_input","fromSide":"right","toNode":"s3_expand","toSide":"left","color":"#3b82f6"},
		{"id":"e_s3_2","fromNode":"s3_expand","fromSide":"right","toNode":"s3_search","toSide":"left","color":"#3b82f6"},
		{"id":"e_s3_3","fromNode":"s3_search","fromSide":"right","toNode":"s3_fuse","toSide":"left","color":"#3b82f6"},
		{"id":"e_s3_4","fromNode":"s3_fuse","fromSide":"right","toNode":"s3_assemble","toSide":"left","color":"#3b82f6"},
		{"id":"e_s3_5","fromNode":"s3_assemble","fromSide":"right","toNode":"s3_verify","toSide":"left","color":"#3b82f6"},
		{"id":"e_p3_to_p4","fromNode":"s3_assemble","fromSide":"bottom","toNode":"s4_prompt","toSide":"top","color":"#10b981","label":"Top-5 context chunks"},
		{"id":"e_s4_1","fromNode":"s4_prompt","fromSide":"right","toNode":"s4_generate","toSide":"left","color":"#10b981"},
		{"id":"e_s4_2","fromNode":"s4_generate","fromSide":"right","toNode":"s4_chainlit","toSide":"left","color":"#10b981"},
		{"id":"e_s4_3","fromNode":"s4_chainlit","fromSide":"right","toNode":"s4_memory","toSide":"left","color":"#10b981"},
		{"id":"e_s4_4","fromNode":"s4_memory","fromSide":"right","toNode":"s4_verify","toSide":"left","color":"#10b981"},
		{"id":"e_s4_5","fromNode":"s4_verify","fromSide":"right","toNode":"s4_done","toSide":"left","color":"#10b981"},
		{"id":"e_p4_to_summary","fromNode":"s4_done","fromSide":"bottom","toNode":"ss_commits","toSide":"top","color":"#8b5cf6","label":"All phases complete"},
		{"id":"e_s5_1","fromNode":"s5_registry","fromSide":"right","toNode":"s5_migrate","toSide":"left","color":"#8b5cf6"},
		{"id":"e_s5_2","fromNode":"s5_migrate","fromSide":"right","toNode":"s5_pipeline","toSide":"left","color":"#8b5cf6"},
		{"id":"e_s5_3","fromNode":"s5_pipeline","fromSide":"right","toNode":"s5_ui","toSide":"left","color":"#8b5cf6"},
		{"id":"e_s5_4","fromNode":"s5_ui","fromSide":"right","toNode":"s5_status","toSide":"left","color":"#8b5cf6"}
	]
}